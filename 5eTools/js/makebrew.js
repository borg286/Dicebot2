"use strict";window.onload=()=>{doPageInit().catch(a=>{throw a})};class PageUi{constructor(){this._builders={},this._$menuInner=null,this._$wrpSource=null,this._$wrpMain=null,this._$wrpInput=null,this._$wrpInputControls=null,this._$wrpOutput=null,this._allSources=[],this._$selSource=null,this.__saveableStates=null,this.doSaveDebounced=MiscUtil.debounce(()=>this._doSave(),50),this._settings={},this._saveSettingsDebounced=MiscUtil.debounce(()=>this._doSaveSettings(),50)}set creatureBuilder(a){this._builders.creatureBuilder=a}get $wrpInput(){return this._$wrpInput}get $wrpInputControls(){return this._$wrpInputControls}get $wrpOutput(){return this._$wrpOutput}get $wrpSideMenu(){return this._$menuInner}get source(){return this._settings.activeSource||""}get allSources(){return this._allSources}set source(a){this._$selSource.val(a),this._settings.activeSource=a,this._doHandleUpdateSource()}_doSave(){this.__saveableStates=this.__saveableStates||{builders:{}},Object.entries(this._builders).forEach(([a,b])=>{(!this.__saveableStates.builders[a]||b.isStateDirty)&&(this.__saveableStates.builders[a]=b.getSaveableState(),b.isStateDirty=!1)}),StorageUtil.pSetForPage(PageUi.STORAGE_STATE,this.__saveableStates)}_doSaveSettings(){StorageUtil.pSetForPage(PageUi.STORAGE_SETTINGS,this._settings)}async init(){this._settings=(await StorageUtil.pGetForPage(PageUi.STORAGE_SETTINGS))||{},this._$wrpLoad=$(`#page_loading`),this._$wrpSource=$(`#page_source`),this._$wrpMain=$(`#page_main`),this._settings.activeBuilder=this._settings.activeBuilder||"creatureBuilder",this._initLhs(),this._initRhs(),this._initSideMenu();const a=(await StorageUtil.pGetForPage(PageUi.STORAGE_STATE))||{};a.builders&&Object.entries(a.builders).forEach(([a,b])=>{this._builders[a]&&this._builders[a].setStateFromLoaded(b)}),this._doRenderActiveBuilder(),this._doInitNavHandler(),this._settings.activeSource&&BrewUtil.homebrewMeta.sources.some(a=>a.json===this._settings.activeSource)?(this.__setStageMain(),this._sideMenuEnabled=!0):(this._doRebuildStageSource({mode:"add",isRequired:!0}),this.__setStageSource())}__setStageSource(){this._$wrpLoad.hide(),this._$wrpSource.show(),this._$wrpMain.hide()}__setStageMain(){this._$wrpLoad.hide(),this._$wrpSource.hide(),this._$wrpMain.show()}_doRebuildStageSource(a){SourceUiUtil.render({...a,$parent:this._$wrpSource,cbConfirm:b=>{const c="edit"!==a.mode;c?BrewUtil.addSource(b):BrewUtil.updateSource(b),this._settings.activeSource=b.json,c&&this._doAddSourceOption(b),this._doHandleUpdateSource(),this._sideMenuEnabled=!0,this.__setStageMain()},cbConfirmExisting:a=>{this._settings.activeSource=a.json,this._doHandleUpdateSource(),this._sideMenuEnabled=!0,this.__setStageMain()},cbCancel:()=>{this._sideMenuEnabled=!0,this.__setStageMain()}})}_initLhs(){this._$wrpInput=$(`#content_input`),this._$wrpInputControls=$(`#content_input_controls`)}_initRhs(){this._$wrpOutput=$(`#content_output`)}_initSideMenu(){const a=$(`.sidemenu`),b=this._settings.activeBuilder,c=$(`<div class="sidemenu__row split-v-center"><div class="sidemenu__row__label mr-2">Mode</div></div>`).appendTo(a),d=$(`
			<select class="form-control input-xs">
				<option value="creatureBuilder">Creature</option>
			</select>
		`).appendTo(c).change(()=>{this._settings.activeBuilder=d.val(),this._builders[this._settings.activeBuilder].renderSideMenu(),this._saveSettingsDebounced()});a.append(PageUi.__$getSideMenuDivider(!0));const e=$(`<div class="sidemenu__row split-v-center"><div class="sidemenu__row__label mr-2">Source</div></div>`).appendTo(a);this._allSources=(BrewUtil.homebrewMeta.sources||[]).sort((c,a)=>SortUtil.ascSortLower(c.full,a.full)).map(a=>a.json),this._$selSource=$$`
			<select class="form-control input-xs">
				<option disabled>Select</option>
				${this._allSources.map(a=>`<option value="${a.escapeQuotes()}">${Parser.sourceJsonToFull(a).escapeQuotes()}</option>`)}
			</select>`.appendTo(e).change(()=>{this._settings.activeSource=this._$selSource.val(),this._doHandleUpdateSource()}),this._settings.activeSource?this._$selSource.val(this._settings.activeSource):this._$selSource[0].selectedIndex=0;const f=$(`<button class="btn btn-default btn-xs mr-2">Edit Selected Source</button>`).click(()=>{const a=this._settings.activeSource,b=BrewUtil.sourceJsonToSource(a);b&&(this._doRebuildStageSource({mode:"edit",source:MiscUtil.copy(b)}),this.__setStageSource())});$$`<div class="sidemenu__row">${f}</div>`.appendTo(a);const g=$(`<button class="btn btn-default btn-xs">Add New Source</button>`).click(()=>{this._doRebuildStageSource({mode:"add"}),this.__setStageSource()});$$`<div class="sidemenu__row">${g}</div>`.appendTo(a),a.append(PageUi.__$getSideMenuDivider(!0)),this._$menuInner=$(`<div/>`).appendTo(a),b&&d.val(b).change()}set _sideMenuEnabled(a){$(`.sidemenu__toggle`).toggle(!!a)}static __$getSideMenuDivider(a){return $(`<hr class="sidemenu__row__divider ${a?"sidemenu__row__divider--heavy":""}">`)}_doRenderActiveBuilder(){const a=this._builders[this._settings.activeBuilder];a.renderInput(),a.renderOutput()}_doInitNavHandler(){}_doAddSourceOption(a){this._allSources.push(a.json),this._$selSource.append(`<option value="${a.json.escapeQuotes()}">${a.full.escapeQuotes()}</option>`),this._builders[this._settings.activeBuilder].doHandleSourcesAdd()}_doHandleUpdateSource(){this._$selSource&&this._$selSource.val(this._settings.activeSource),this._saveSettingsDebounced(),this._builders[this._settings.activeBuilder].doHandleSourceUpdate()}_getJsonOutputTemplate(){return{_meta:{sources:[MiscUtil.copy(BrewUtil.sourceJsonToSource(this._settings.activeSource))]}}}}PageUi.STORAGE_STATE="brewbuilderState",PageUi.STORAGE_SETTINGS="brewbuilderSettings";class Builder{static async pInitAll(){return Promise.all(Builder._BUILDERS.map(a=>a.pInit()))}constructor(){this._ui=null,this._isStateDirty=!1,this._isEntrySaved=!0,Builder._BUILDERS.push(this),ProxyUtil.decorate(this)}set ui(a){this._ui=a}get isStateDirty(){return this._isStateDirty}set isStateDirty(a){this._isStateDirty=a}get isEntrySaved(){return this._isEntrySaved}set isEntrySaved(a){this._isEntrySaved=a}getSaveableState(){throw new TypeError(`Unimplemented method!`)}setStateFromLoaded(){throw new TypeError(`Unimplemented method!`)}doHandleSourceUpdate(){throw new TypeError(`Unimplemented method!`)}doHandleSourcesAdd(){throw new TypeError(`Unimplemented method!`)}renderInput(){throw new TypeError(`Unimplemented method!`)}renderOutput(){throw new TypeError(`Unimplemented method!`)}renderSideMenu(){throw new TypeError(`Unimplemented method!`)}getOnNavMessage(){throw new TypeError(`Unimplemented method!`)}async pInit(){}}Builder._BUILDERS=[];class BuilderUi{static $getSaveButton(){return $(`<button class="btn btn-xs btn-default mr-2 mkbru__cnt-save">Save</button>`)}static $getResetButton(){return $(`<button class="btn btn-xs btn-default">Reset</button>`)}static __setProp(a,b,c,...d){if(1<d.length){let b=c;for(let a=0;a<d.length-1;++a)b=c[d[a]];return null==a?(delete b[d.last()],null):b[d.last()]=a}return null==a?(delete c[d[0]],null):c[d[0]]=a}static getLabelledRowTuple(a,b){b=b||{};const c=b.eleType||"div",d=$(`<div class="${b.isRow?"flex":"flex-col"} full-width"/>`),e=$$`<div class="mb-2 mkbru__row stripe-even"><${c} class="mkbru__wrp-row flex-v-center"><span class="mr-2 mkbru__row-name ${b.isMarked?`mkbru__row-name--marked`:""}">${a}</span>${b.isMarked?`<div class="mkbru__row-mark mr-2"/>`:""}${d}</${c}></div>`;return[e,d]}static __$getRow(a,b,c){c=c||{};const d=c.eleType||"div";return $$`<div class="mb-2 mkbru__row stripe-even"><${d} class="mkbru__wrp-row flex-v-center">
		<span class="mr-2 mkbru__row-name ${c.title?"help":""}" ${c.title?`title="${c.title}"`:""}>${a}</span>
		${b}
		<${d}/></div>`}static $getStateIptString(a,b,c,d,...e){null==d.nullable&&(d.nullable=!0);const f=MiscUtil.getProperty(c,...e),g=$(`<input class="form-control input-xs form-control--minimal ${d.type?`type="${d.type}"`:""}">`).val(f).change(()=>{const a=g.val().trim(),f=BuilderUi.__setProp(a||!d.nullable?a:null,d,c,...e);b(),d.callback&&d.callback(f)});return BuilderUi.__$getRow(a,g,d)}static $getStateIptEntries(a,b,c,d,...e){null==d.nullable&&(d.nullable=!0);const f=MiscUtil.getProperty(c,...e),g=$(`<textarea class="form-control form-control--minimal mkbru__ipt-textarea" ${d.placeholder?`placeholder="${d.placeholder}"`:""}/>`).val(BuilderUi.getEntriesAsText(f)).change(()=>{const a=g.val().trim();BuilderUi.__setProp(a||!d.nullable?BuilderUi.getTextAsEntries(a):null,d,c,...e),b()});return BuilderUi.__$getRow(a,g,d)}static $getStateIptStringArray(a,b,c,d,...e){null==d.nullable&&(d.nullable=!0);const[f,g]=BuilderUi.getLabelledRowTuple(a,{isMarked:!0}),h=MiscUtil.getProperty(c,...e)||[],i=[],j=()=>{const a=i.map(a=>a.getState()).filter(a=>a.trim());BuilderUi.__setProp(a.length||!d.nullable?a:null,d,c,...e),b()},k=$(`<div/>`).appendTo(g);h.forEach(a=>BuilderUi.$getStateIptStringArray__getRow(j,i,a).$wrp.appendTo(k));const l=$(`<div/>`).appendTo(g);return $(`<button class="btn btn-xs btn-default">Add ${d.shortName}</button>`).appendTo(l).click(()=>{BuilderUi.$getStateIptStringArray__getRow(j,i).$wrp.appendTo(k),j()}),f}static $getStateIptStringArray__getRow(a,b,c){const d=$(`<input class="form-control form-control--minimal input-xs mr-2">`).change(()=>a());c&&c.trim()&&d.val(c);const e=$(`<button class="btn btn-xs btn-danger" title="Remove Row"><span class="glyphicon glyphicon-trash"/></button>`).click(()=>{b.splice(b.indexOf(g),1),f.empty().remove(),a()}),f=$$`<div class="flex-v-center mb-2">${d}${e}</div>`,g={$wrp:f,getState:()=>d.val().trim()};return b.push(g),g}static $getStateIptNumber(a,b,c,d,...e){null==d.nullable&&(d.nullable=!0);const f=MiscUtil.getProperty(c,...e),g=$(`<input class="form-control input-xs form-control--minimal" type="number" ${d.placeholder?`placeholder="${d.placeholder}"`:""}>`).val(f).change(()=>{const a=g.val().trim();BuilderUi.__setProp(a||!d.nullable?+a:null,d,c,...e),b()});return BuilderUi.__$getRow(a,g,d)}static $getStateIptEnum(a,b,c,d,...e){null==d.nullable&&(d.nullable=!0);const f=MiscUtil.getProperty(c,...e),g=$(`<select class="form-control input-xs form-control--minimal">`);d.nullable&&g.append(`<option value="-1">(None)</option>`),d.vals.forEach((a,b)=>$(`<option>`).val(b).text(d.fnDisplay?d.fnDisplay(a):a).appendTo(g));const h=d.vals.indexOf(f);return g.val(h).change(()=>{const a=+g.val(),f=~a?d.vals[a]:null;BuilderUi.__setProp(f,d,c,...e),b()}),BuilderUi.__$getRow(a,g,d)}static $getStateIptBoolean(a,b,c,d,...e){null==d.nullable&&(d.nullable=!0);const f=MiscUtil.getProperty(c,...e),g=$(`<input class="mkbru__ipt-cb" type="checkbox">`).prop("checked",f).change(()=>{const a=!!g.prop("checked");BuilderUi.__setProp(a||!d.nullable?a:null,d,c,...e),b()});return BuilderUi.__$getRow(a,$$`<div class="full-width flex-v-center">${g}</div>`,{...d,eleType:"label"})}static $getStateIptBooleanArray(a,b,c,d,...e){null==d.nullable&&(d.nullable=!0);const[f,g]=BuilderUi.getLabelledRowTuple(a,{isMarked:!0}),h=MiscUtil.getProperty(c,...e)||[],i=$(`<div class="flex-col full-width mr-2"/>`).appendTo(g),j=[];d.vals.forEach(a=>{const f=$(`<input class="mkbru__ipt-cb" type="checkbox">`).prop("checked",h.includes(a)).change(()=>{BuilderUi.__setProp(k(),d,c,...e),b()});j.push({$ipt:f,val:a}),$$`<label class="flex-v-center split stripe-odd--faint"><span>${d.fnDisplay?d.fnDisplay(a):a}</span>${f}</label>`.appendTo(i)});const k=()=>{const a=j.map(a=>!!a.$ipt.prop("checked")&&a.val).filter(Boolean);return a.length||!d.nullable?a:null};return f}static getEntriesAsText(a){return a&&a.length?JSON.stringify(a,null,2).replace(/^\s*\[/,"").replace(/]\s*$/,"").split("\n").filter(a=>a.trim()).map(a=>{const b=a.replace(/^\s\s/,""),c=/^"(.*?)"$/.exec(b);return c?c[1]:`  ${b}`}).join("\n"):""}static getTextAsEntries(a){try{const b=[];return a.split("\n").filter(a=>a.trim()).forEach(a=>{/^\s/.exec(a)?b.push(a):b.push(`"${a.replace(/"/g,`\\"`)}",`)}),b.length&&(b[b.length-1]=b.last().replace(/^(.*?),?$/,"$1")),JSON.parse(`[${b.join("")}]`)}catch(b){const c=a.split("\n").filter(a=>a.trim()),d=c.join(" \\ ").substring(0,30);return JqueryUtil.doToast({content:`Could not parse entries! Error was: ${b.message}<br>Text was: ${d}${30===d.length?"...":""}`,type:"danger"}),c}}static pGetUserSpellSearch(a){return a=a||{},new Promise(b=>{const c={defaultCategory:"alt_Spell"};null!=a.level&&(c.resultFilter=b=>b.lvl===a.level);const d=new SearchWidget({alt_Spell:SearchWidget.CONTENT_INDICES.alt_Spell},(a,c,d)=>{const[f,g]=d.split(HASH_LIST_SEP);e.data("close")(!1),b(`{@spell ${decodeURIComponent(f)}${g===UrlUtil.encodeForHash(SRC_PHB)?"":`|${decodeURIComponent(g)}`}}`)},c),e=UiUtil.getShow$Modal("Select Spell",a=>{d.$wrpSearch.detach(),a&&b(null)});e.append(d.$wrpSearch),d.doFocus()})}static $getSplitCommasSortButton(a,b,c){return c=c||{},$(`<button class="btn btn-xs btn-default">Sort</button>`).click(()=>{const d=a.val().split(StrUtil.COMMAS_NOT_IN_PARENTHESES_REGEX);a.val(d.sort((d,a)=>{if(c.bottom){const b=c.bottom.findIndex(a=>{const b=a.test(d);return a.lastIndex=0,b}),e=c.bottom.findIndex(b=>{const c=b.test(a);return b.lastIndex=0,c});return~b&&~e?0:~b?1:~e?-1:SortUtil.ascSortLower(d,a)}return SortUtil.ascSortLower(d,a)}).join(", ")),b()})}static $getUpButton(a,b,c){return $(`<button class="btn btn-xs btn-default mkbru__btn-up-row ml-2" title="Move Up"><span class="glyphicon glyphicon-arrow-up"/></button>`).click(()=>{const d=b.indexOf(c),e=b[d-1];b[d-1]=c,b[d]=e,a()})}static $getDownButton(a,b,c){return $(`<button class="btn btn-xs btn-default mkbru__btn-down-row ml-2" title="Move Down"><span class="glyphicon glyphicon-arrow-down"/></button>`).click(()=>{const d=b.indexOf(c),e=b[d+1];b[d+1]=c,b[d]=e,a()})}static $getDragPad(a,b,c,d){const e={},f=()=>{e.on=!1,e.$wrap.remove(),e.$dummies.forEach(a=>a.remove())},g=()=>{e.on&&f(),e.on=!0,e.$wrap=$(`<div class="flex-col mkbru__wrp-drag-block"/>`).appendTo(d.$wrpRowsOuter),e.$dummies=[];const h=b.indexOf(c);b.forEach((j,k)=>{const i={w:j.$ele.outerWidth(!0),h:j.$ele.outerHeight(!0)},l=$(`<div class="mkbru__wrp-drag-dummy ${k===h?"mkbru__wrp-drag-dummy--highlight":"mkbru__wrp-drag-dummy--lowlight"}"/>`).width(i.w).height(i.h).mouseup(()=>{e.on&&f()}).appendTo(e.$wrap);e.$dummies.push(l),k!==h&&l.mouseenter(()=>{const e=b[k];b[k]=c,b[h]=e,d.cbSwap&&d.cbSwap(e),a(),g()})})};return $(`<div class="ml-2 mkbru__drag-patch" title="Drag to Reorder">
		<div class="mkbru__drag-patch-col"><div>&#8729</div><div>&#8729</div><div>&#8729</div></div>
		<div class="mkbru__drag-patch-col"><div>&#8729</div><div>&#8729</div><div>&#8729</div></div>
		</div>`).mousedown(()=>g())}}async function doPageInit(){ExcludeUtil.pInitialise();try{await BrewUtil.pAddBrewData(),await BrewUtil.pAddLocalBrewData()}catch(a){await BrewUtil.pPurgeBrew(),setTimeout(()=>{throw a})}return await SearchUiUtil.pDoGlobalInit(),await SearchWidget.pDoGlobalInit(),await Builder.pInitAll(),Renderer.utils.bindPronounceButtons(),ui.init()}const ui=new PageUi;